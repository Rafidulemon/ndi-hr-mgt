generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  ORG_ADMIN
  HR_ADMIN
  MANAGER
  EMPLOYEE
}

enum Gender {
  MALE
  FEMALE
  NON_BINARY
  UNDISCLOSED
}

enum WorkModel {
  ONSITE
  HYBRID
  REMOTE
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERN
}

enum EmploymentStatus {
  ACTIVE
  PROBATION
  INACTIVE
  TERMINATED
  SABBATICAL
}

enum AttendanceStatus {
  PRESENT
  LATE
  HALF_DAY
  ABSENT
  REMOTE
  HOLIDAY
}

enum LeaveStatus {
  DRAFT
  PENDING
  PROCESSING
  APPROVED
  DENIED
  CANCELLED
}

enum LeaveType {
  CASUAL
  SICK
  ANNUAL
  PATERNITY_MATERNITY
}

enum ProjectStatus {
  ACTIVE
  ON_HOLD
  COMPLETED
  ARCHIVED
}

enum NotificationType {
  SYSTEM
  LEAVE
  ATTENDANCE
  PAYROLL
  GENERAL
}

enum NotificationStatus {
  DRAFT
  SCHEDULED
  SENT
  CANCELLED
}

/// Top-level organisation/workspace that owns employees and policies.
model Organization {
  id        String   @id @default(uuid())
  name      String
  domain    String?  @unique
  timezone  String?  @default("Asia/Dhaka")
  locale    String?  @default("en-US")
  orgAdminId String?
  managerId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users             User[]
  departments       Department[]
  employmentDetails EmploymentDetail[]
  teams             Team[]
  projects          Project[]
  notifications     Notification[]
  holidays          Holiday[]
  workPolicy        WorkPolicy?
  orgAdmin          User?          @relation("OrganizationAdmin", fields: [orgAdminId], references: [id])
  manager           User?          @relation("OrganizationManager", fields: [managerId], references: [id])

  @@index([name])
  @@index([orgAdminId])
  @@index([managerId])
}

/// Authenticated user record. One row per employee/admin.
model User {
  id             String           @id @default(uuid())
  organizationId String
  email          String           @unique
  passwordHash   String
  phone          String?
  role           UserRole         @default(EMPLOYEE)
  status         EmploymentStatus @default(ACTIVE)
  lastLoginAt    DateTime?
  invitedAt      DateTime?
  archivedAt     DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  organization          Organization          @relation(fields: [organizationId], references: [id])
  profile               EmployeeProfile?      @relation("EmployeeProfileUser")
  employment            EmploymentDetail?     @relation("EmployeeEmployment")
  emergencyContacts     EmergencyContact[]
  bankAccounts          EmployeeBankAccount[]
  attendanceRecords     AttendanceRecord[]
  leaveRequests         LeaveRequest[]        @relation("LeaveAuthor")
  reviewedLeaveRequests LeaveRequest[]        @relation("LeaveReviewer")
  notificationsSent     Notification[]        @relation("NotificationSender")
  headedDepartments     Department[]          @relation("DepartmentHead")
  ledTeams              Team[]                @relation("TeamLead")
  directReports         EmploymentDetail[]    @relation("ManagerReports")
  teamMemberships       TeamManager[]
  administeredOrganizations Organization[]    @relation("OrganizationAdmin")
  managedOrganizations      Organization[]    @relation("OrganizationManager")
  sessions              Session[]
  passwordResetTokens   PasswordResetToken[]

  @@index([organizationId])
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

/// Extended profile information captured from the employee.
model EmployeeProfile {
  id               String     @id @default(uuid())
  userId           String     @unique
  firstName        String
  lastName         String
  preferredName    String?
  gender           Gender?
  dateOfBirth      DateTime?
  nationality      String?
  bio              String?
  profilePhotoUrl  String?
  workModel        WorkModel?
  currentAddress   String?
  permanentAddress String?
  personalEmail    String?
  workEmail        String?
  workPhone        String?
  personalPhone    String?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  user User @relation("EmployeeProfileUser", fields: [userId], references: [id])
}

model EmergencyContact {
  id             String   @id @default(uuid())
  userId         String
  name           String
  relationship   String
  phone          String
  alternatePhone String?
  email          String?
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

model EmployeeBankAccount {
  id            String   @id @default(uuid())
  userId        String
  accountHolder String
  bankName      String
  accountNumber String
  branch        String?
  swiftCode     String?
  taxId         String?
  isPrimary     Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

/// Canonical employment data linked to an organisation.
model EmploymentDetail {
  id                 String           @id @default(uuid())
  userId             String           @unique
  organizationId     String
  employeeCode       String?
  designation        String
  employmentType     EmploymentType
  status             EmploymentStatus @default(ACTIVE)
  startDate          DateTime
  endDate            DateTime?
  departmentId       String?
  teamId             String?
  reportingManagerId String?
  currentProjectId   String?
  primaryLocation    String?
  workHours          String?
  currentProjectNote String?
  casualLeaveBalance   Decimal   @default(0) @db.Decimal(5, 2)
  sickLeaveBalance     Decimal   @default(0) @db.Decimal(5, 2)
  annualLeaveBalance   Decimal   @default(0) @db.Decimal(5, 2)
  parentalLeaveBalance Decimal   @default(0) @db.Decimal(5, 2)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  user           User         @relation("EmployeeEmployment", fields: [userId], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id])
  department     Department?  @relation(fields: [departmentId], references: [id])
  team           Team?        @relation("PrimaryTeam", fields: [teamId], references: [id])
  manager        User?        @relation("ManagerReports", fields: [reportingManagerId], references: [id])
  currentProject Project?     @relation("CurrentProject", fields: [currentProjectId], references: [id])

  @@unique([organizationId, employeeCode])
  @@index([organizationId])
  @@index([departmentId])
  @@index([teamId])
  @@index([reportingManagerId])
}

model Department {
  id             String   @id @default(uuid())
  organizationId String
  name           String
  code           String?
  description    String?
  headId         String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization       @relation(fields: [organizationId], references: [id])
  head         User?              @relation("DepartmentHead", fields: [headId], references: [id])
  employees    EmploymentDetail[]
  teams        Team[]

  @@unique([organizationId, name])
  @@unique([organizationId, code])
  @@index([organizationId])
}

model Team {
  id             String   @id @default(uuid())
  organizationId String
  departmentId   String
  name           String
  description    String?
  leadId         String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization   Organization       @relation(fields: [organizationId], references: [id])
  department     Department         @relation(fields: [departmentId], references: [id])
  lead           User?              @relation("TeamLead", fields: [leadId], references: [id])
  primaryMembers EmploymentDetail[] @relation("PrimaryTeam")
  teamManagers   TeamManager[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([departmentId])
}

model TeamManager {
  id        String   @id @default(uuid())
  teamId    String
  managerId String
  createdAt DateTime @default(now())

  team    Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  manager User @relation(fields: [managerId], references: [id], onDelete: Cascade)

  @@unique([teamId, managerId])
  @@index([managerId])
}

model AttendanceRecord {
  id                String           @id @default(uuid())
  employeeId        String
  attendanceDate    DateTime
  checkInAt         DateTime?
  checkOutAt        DateTime?
  totalWorkSeconds  Int?
  totalBreakSeconds Int?
  status            AttendanceStatus
  note              String?
  location          String?
  source            String?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  employee User @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, attendanceDate])
  @@index([attendanceDate])
  @@index([employeeId])
}

model LeaveRequest {
  id          String      @id @default(uuid())
  employeeId  String
  leaveType   LeaveType
  startDate   DateTime
  endDate     DateTime
  totalDays   Decimal     @db.Decimal(5, 2)
  status      LeaveStatus @default(PENDING)
  reason      String?
  note        String?
  attachments Json?
  reviewerId  String?
  reviewedAt  DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  employee    User              @relation("LeaveAuthor", fields: [employeeId], references: [id])
  reviewer    User?             @relation("LeaveReviewer", fields: [reviewerId], references: [id])

  @@index([employeeId, startDate])
  @@index([status])
}

model Project {
  id             String        @id @default(uuid())
  organizationId String
  name           String
  code           String?
  description    String?
  clientName     String?
  status         ProjectStatus @default(ACTIVE)
  startDate      DateTime?
  endDate        DateTime?
  projectManager String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  organization       Organization       @relation(fields: [organizationId], references: [id])
  currentAssignments EmploymentDetail[] @relation("CurrentProject")

  @@unique([organizationId, name])
  @@unique([organizationId, code])
  @@index([organizationId])
}

model Notification {
  id             String             @id @default(uuid())
  organizationId String
  senderId       String?
  title          String
  body           String
  type           NotificationType   @default(GENERAL)
  status         NotificationStatus @default(DRAFT)
  actionUrl      String?
  metadata       Json?
  scheduledAt    DateTime?
  sentAt         DateTime?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  sender       User?        @relation("NotificationSender", fields: [senderId], references: [id])

  @@index([organizationId])
}

model Holiday {
  id             String   @id @default(uuid())
  organizationId String
  title          String
  description    String?
  date           DateTime
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, date])
  @@index([organizationId, date])
}

model WorkPolicy {
  id               String   @id @default(uuid())
  organizationId   String   @unique
  onsiteStartTime  String
  onsiteEndTime    String
  remoteStartTime  String
  remoteEndTime    String
  workingDays      String[]
  weekendDays      String[]
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
}
